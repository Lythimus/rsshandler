usePlugin 'java'

sourceCompatibility = 1.6

archivesBaseName = 'rsshandler'

version = '1.0'

manifest.mainAttributes(
    'Main-Class': 'com.rsshandler.Main',
)

repositories {
    mavenCentral()
}

dependencies {
    compile group: 'org.eclipse.jetty', name: 'jetty-server', version: '7.0.1.v20091125'
    compile group: 'org.eclipse.jetty', name: 'jetty-servlet', version: '7.0.1.v20091125'
    compile group: 'org.eclipse.jetty', name: 'jetty-util', version: '7.0.1.v20091125'
    compile group: 'org.eclipse.jetty', name: 'jetty-http', version: '7.0.1.v20091125'
    compile group: 'javax.servlet', name: 'servlet-api', version: '2.5'
    compile group: 'com.miglayout', name: 'miglayout', version: '3.7.2'
    testCompile group: 'junit', name: 'junit', version: '4.+'
}

ant {
  taskdef( name: 'gcupload', classname: 'net.bluecow.googlecode.ant.GoogleCodeUploadTask', classpath: 'ant/ant-googlecode-0.0.2.jar' )
}

jar.doLast {
  ant.signjar(destDir: 'build/signed', jar: tasks.jar.archivePath, alias:"myself", keystore:"myKeystore",
          storepass:"123456", preservelastmodified:"true")
  ant.copy(file:'rsshandler.jnlp', todir:'build/signed')
}

task copyAndSign << {
    ant.delete(dir:'build/signed')
    ant.mkdir(dir:'build/signed')
    for(file in configurations.runtime.resolve()) {
      ant.signjar(destDir: 'build/signed', jar: file, alias:"myself", keystore:"myKeystore",
              storepass:"123456", preservelastmodified:"true")
    }
}

task uploadJar(dependsOn: 'jar') << {
  ant.gcupload(username:gcusername, password:gcpassword, projectname:"rsshandler", 
      filename:'build/signed/rsshandler-1.0.jar', targetfilename:'rsshandler-1.0.jar', summary:"RSS Handler java binary files", labels:"Featured")
  ant.gcupload(username:gcusername, password:gcpassword, projectname:"rsshandler", 
      filename:'build/signed/rsshandler.jnlp', targetfilename:'rsshandler.jnlp', summary:"JWS installation script", labels:"Featured")
}

task uploadAll << {
  collection = files { file('build/signed/').listFiles() }
  collection.each { 
    ant.gcupload(username:gcusername, password:gcpassword, projectname:"rsshandler", 
        filename:it, 
          targetfilename:it.name, summary:"automatic", labels:"")
  }
}


